<polymer-element name="floating-menu-vail">
  <link href="floating-menu.css" rel="stylesheet" type="text/css">
  <template></template>
  <script>
    Polymer('floating-menu-vail', {
      ready: function() {
        this.setAttribute('touch-action', 'none')
        this.classList.add('floating-menu-vail')
      },
      visibleChanged: function() {
        this.classList.toggle('visible', this.visible)
      }
    })
  </script>
</polymer-element>

<polymer-element name="floating-menu" attributes="parent options">
  <template>
    <link href="floating-menu.css" rel="stylesheet" type="text/css">
    <floating-submenu id="mainmenu">
      <template repeat="{{options}}" id="root">
        <floating-menu-item id="item" label="{{label}}" action="{{action}}">
          <floating-submenu ref="item" empty="{{options == undefined}}">
            <template ref="root" repeat="{{options}}"></template>
          </floating-submenu>
        </floating-menu-item>
      </template>
    </floating-submenu>
  </template>
  <script>
    (function() {

      var vail = document.createElement('floating-menu-vail')
      var dist = function(x1, y1, x2, y2) {  
        return Math.sqrt( Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2) );
      }

      Polymer('floating-menu', {
        ready: function() {
          this.setAttribute('touch-action', 'none')
          this.classList.add('floating-menu')
          this.parent = this.parent || document.body;
          this.parent.setAttribute( 'oncontextmenu', 'return false')
          document.body.appendChild(vail)
        },
        parentChanged: function() {

          var scope = this
          var closeTimeout

          var x = 0, y = 0, d = 0

          this.parent.addEventListener('pointerdown', function(event){
            event.preventDefault()
            x = event.clientX
            y = event.clientY
          }, false)

          this.parent.addEventListener('pointerup', function(event){
            event.preventDefault()
            var l = dist(x, y, event.clientX, event.clientY)
            var isRightClick = (event.pointerId == 1 && event.button == 2 && l < 5)
            var isTap = (event.pointerId > 1 && l < 5)

            if (isRightClick || isTap) {
              scope.visible = true
              scope.style.top = event.clientY - 8 + "px"
              scope.style.left = event.clientX - 8 + "px"
              clearTimeout(closeTimeout)
            }
          }, false)

          this.addEventListener('pointermove', function(event){
            // console.log(event)
            event.stopPropagation()
            var newD = Math.abs(event.pageY - y) -(event.pageX - x)
            d = (d*2 + newD) / 3
            x = event.pageX
            y = event.pageY
            clearTimeout(closeTimeout)
          }, false)

          vail.addEventListener('pointerover', function(event){
            event.stopPropagation()
            closeTimeout = setTimeout(function(){
              scope.visible = false
            }, 500)
          }, false)
          vail.addEventListener('pointerdown', function(event){
            event.stopPropagation()
            event.preventDefault()
            scope.visible = false
          }, false)
          vail.addEventListener('pointermove', function(event){
            event.stopPropagation()
            event.preventDefault()
          }, false)
          vail.addEventListener('pointerup', function(event){
            event.stopPropagation()
            event.preventDefault()
          }, false)

          window.addEventListener('scroll', function(event){
            scope.visible = false
          }, false)
          this.addEventListener('floating-menu-item-clicked', function(event){
            scope.visible = false
          }, false)

          var expandTimeout = {};

          this.addEventListener('floating-item-hovered', function(event){
            clearTimeout(expandTimeout)
            var isMouse = (event.detail.pointerId == 1)

            var noneSelected = true
            var c = event.detail.parentNode.childNodes
            for (var i = 0; i < c.length; i++ ){
              if (c[i].nodeName == "FLOATING-MENU-ITEM" && c[i] != event.detail && c[i].expanded) {
                noneSelected = false
              }
            } 

            if (d > 0 || !isMouse || noneSelected) {// || expandTimeout.cleared) {
              expandSubmenu(event.detail)         
            } else {
              expandTimeout.cleared = false;
              expandTimeout = setTimeout(function(){expandSubmenu(event.detail)}, 1000) 
            }

          }, false)

          var expandSubmenu = function(node) {
            node.expanded = true
            expandTimeout.cleared = true;
            Platform.flush()
          }

          this.addEventListener('pointerup', function(event){
            event.stopPropagation()
          }, false)
          // right clipping
          this.addEventListener('floating-submenu-clipped', function(event){
            var rect = scope.getBoundingClientRect()
            scope.style.left = rect.left - event.detail + 'px'
          })
        },
        visibleChanged: function() {
          this.classList.toggle('visible', this.visible)
          this.$.mainmenu.visible = this.visible
          this.$.mainmenu.expanded = this.visible
          vail.visible = this.visible
        }
      })

    }())
  </script>
</polymer-element>

<polymer-element name="floating-submenu" attributes="expanded empty">
  <link href="floating-menu.css" rel="stylesheet" type="text/css">
  <template><content></content></template>
  <script>
    Polymer('floating-submenu', {
      top: 0,
      ready: function() {
        this.setAttribute('touch-action', 'none')
        this.classList.add('floating-submenu')
        var scope = this;

        this.addEventListener('floating-item-expanded', function(event){
          event.stopPropagation()
          // unexpand all except the one just expanded
          var c = this.childNodes
          for (var i = 0; i < c.length; i++ ){
            if (c[i].nodeName == "FLOATING-MENU-ITEM" && c[i] != event.detail) {
              c[i].expanded = false
            }
          }
        }, false)
      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded)
        this.style.visibility = 'hidden'
        // unexpand all
        var c = this.childNodes
        for (var i = 0; i < c.length; i++ ){
          if (c[i].nodeName == "FLOATING-MENU-ITEM") c[i].expanded = false
        }
        if (this.expanded) {
          // bottom clipping
          var rect = this.getBoundingClientRect()
          var bottomDist = (rect.bottom-this.top+16) - window.innerHeight
          if (bottomDist > 0) this.top = - bottomDist
          else this.top = 0
          // right clipping
          var rightDist = (rect.right+16) - window.innerWidth 
          if (rightDist > 0) this.fire('floating-submenu-clipped', rightDist)
        }
        Platform.flush()
        this.style.visibility = 'visible'
      },
      topChanged: function() {
        this.style.top = this.top + 'px'
      },
      emptyChanged: function() {
        this.classList.toggle('empty', this.empty)
      }
    })
  </script>
</polymer-element>

<polymer-element name="floating-menu-item" attributes="label action expanded">
  <template>
    <link href="floating-menu.css" rel="stylesheet" type="text/css">
    {{label}}<content></content>
  </template>
  <script>
    Polymer('floating-menu-item', {
      label: '',
      ready: function() {
        this.setAttribute('touch-action', 'none')
        this.classList.add('floating-menu-item')
        this.classList.add('empty')
      },
      labelChanged: function() {
        var scope = this
        this.classList.remove('empty')
        this.addEventListener('pointerover', function(event) {  
          scope.pointerId = event.pointerId
          this.fire('floating-item-hovered', scope)
          event.stopPropagation()  
        }, false)
      },
      actionChanged: function() {
        var scope = this
        this.addEventListener('pointerup', function(event) {
          event.stopPropagation()
          scope.action()
          scope.fire('floating-menu-item-clicked', scope)
        }, false)
      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded)
        if (this.expanded) this.fire('floating-item-expanded', this);

        // TODO: identify submenu better
        if (!this.submenu){
          var c = this.childNodes
          for (var i = 0; i < c.length; i++ ){
            if (c[i].nodeName == "FLOATING-SUBMENU") {
              this.submenu = c[i]
            }
          } 
        }  
        this.submenu.expanded = this.expanded
      }
    })
  </script>
</polymer-element>