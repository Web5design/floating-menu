<polymer-element name="floating-menu-vail">
  <link href="floating-menu.css" rel="stylesheet" type="text/css">
  <template></template>
  <script>
    Polymer('floating-menu-vail', {
      ready: function() {
        this.setAttribute('touch-action', 'none')
        this.classList.add('floating-menu-vail')
      }
    })
  </script>
</polymer-element>

<polymer-element name="floating-menu" attributes="parent options">
  <template>
    <link href="floating-menu.css" rel="stylesheet" type="text/css">
      <template repeat="{{options}}" id="root">
        <floating-menu-item label="{{label}}" action="{{action}}">
          <div id="submenu" class="{{options == undefined ? 'empty' : 'not-empty'}}">
            <template ref="root" repeat="{{options}}"></template>
          </div>
        </floating-menu-item>
      </template>
  </template>
  <script>
    (function() {

      var vail = document.createElement('floating-menu-vail')
      var dist = function(x1, y1, x2, y2) {  
        return Math.sqrt( Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2) );
      }

      Polymer('floating-menu', {
        ready: function() {
          this.setAttribute('touch-action', 'none')
          this.classList.add('floating-menu')
          document.body.appendChild(vail)
          document.body.setAttribute( 'oncontextmenu', 'return false')
          if (!this.parent) this.parent = document.body;
        },
        parentChanged: function() {

          var scope = this
          var closeTimeout;

          var x = 0, y = 0, d = 0;

          this.parent.addEventListener('pointerdown', function(event){
            x = event.clientX
            y = event.clientY
          }, false)

          this.parent.addEventListener('pointerup', function(event){
            var d = dist(x, y, event.clientX, event.clientY)
            var isRightClick = (event.pointerId == 1 && event.button == 2 && d < 5)
            var isTap = (event.pointerId == 2 && d < 5)
            if (isRightClick || isTap) {
              scope.visible = true
              scope.style.top = event.clientY - 8 + "px"
              scope.style.left = event.clientX - 8 + "px"

              // clipping
              var rect = scope.getBoundingClientRect()
              var bottomDist = (rect.bottom+16) - window.innerHeight 
              if (bottomDist > 0){
                scope.style.top = window.innerHeight - rect.height - 16 + 'px'
              }
              var rightDist = (rect.right+16) - window.innerWidth 
              if (rightDist > 0){
                scope.style.left = window.innerWidth - rect.width - 16 + 'px'
              }
              Platform.flush()

            }
          }, false)

          vail.addEventListener('pointerover', function(event){
            closeTimeout = setTimeout(function(){
              scope.visible = false
            }, 500)
          }, false)
          window.addEventListener('scroll', function(event){
            scope.visible = false
          }, false)

          this.addEventListener('pointerdown', function(event){
            event.stopPropagation()
          }, false)
          this.addEventListener('pointermove', function(event){
            event.stopPropagation();
            clearTimeout(closeTimeout)
          }, false)
          this.addEventListener('pointerup', function(event){
            event.stopPropagation()
          }, false)
          this.addEventListener('floating-menu-item-clicked', function(event){
            scope.visible = false
          }, false)

          this.addEventListener('pointermove', function(event){
            event.stopPropagation()
            var newD = Math.abs(event.clientY - y) -(event.clientX - x)
            d = (d*2 + newD) / 3
            x = event.clientX
            y = event.clientY
          }, false)

          var expandTimeout = {};
          this.addEventListener('submenu-expanded', function(event){
            clearTimeout(expandTimeout)
            if (d > 0 || expandTimeout.cleared) {
              expandSubmenu(event.detail)
            } else {
              expandTimeout.cleared = false;
              expandTimeout = setTimeout(function(){expandSubmenu(event.detail)}, 1000) 
            }
          }, false)

          this.addEventListener('floating-submenu-clipped', function(event){
            var rect = scope.getBoundingClientRect()
            scope.style.left = rect.left - event.detail + 'px'
          })

          var expandSubmenu = function(node) {
            node.expanded = true
            var s = node.parentNode.childNodes
            for (var i = 0; i < s.length; i++ ){
              if (s[i].nodeName == "FLOATING-MENU-ITEM" && s[i] != node) {
                s[i].expanded = false
              }
            }
            expandTimeout.cleared = true;
          }

        },

        visibleChanged: function() {
          this.classList.toggle('visible', this.visible)
          vail.classList.toggle('visible', this.visible)
          if (!this.visible) {
            var c = this.shadowRoot.childNodes
            for (var i = 0; i < c.length; i++ ){
              if (c[i].nodeName == "FLOATING-MENU-ITEM") {
                c[i].expanded = false
              }
            }            
          }
        }
      })

    }())
  </script>
</polymer-element>

<polymer-element name="floating-menu-item" attributes="label action">
<template>
  <link href="floating-menu.css" rel="stylesheet" type="text/css">
  {{label}}<content></content>
</template>
<script>
  Polymer('floating-menu-item', {
    label: '',
    ready: function() {
      this.setAttribute('touch-action', 'none')
      this.classList.add('floating-menu-item')
      this.classList.add('empty')
    },
    labelChanged: function() {

      var scope = this

      this.classList.remove('empty')
      this.addEventListener('pointerover', function(event) {
        
        this.fire('submenu-expanded', scope)
        event.stopPropagation();  

      }, false)

    },
    actionChanged: function() {
      var scope = this
      this.addEventListener('pointerup', function(event) {
        event.stopPropagation()
        scope.action()
        scope.fire('floating-menu-item-clicked', scope)
      }, false)
    },
    expandedChanged: function() {
      this.classList.toggle('expanded', this.expanded)
      var submenu = this.childNodes[1];  // TODO make less ugly. [1] <- submenu
      
      var c = submenu.childNodes
      for (var i = 0; i < c.length; i++ ){
        if (c[i].nodeName == "FLOATING-MENU-ITEM") {
          c[i].expanded = false
        }
      }

      //clipping
      if (this.expanded) {
        submenu.style.top = '0'
        var rect = submenu.getBoundingClientRect()
        var bottomDist = (rect.bottom+16) - window.innerHeight 
        if (bottomDist > 0){
          submenu.style.top = - bottomDist + 'px'
        } else {
          submenu.style.top = '0'
        } 
      }
      var rect = submenu.getBoundingClientRect()
      var rightDist = (rect.right+16) - window.innerWidth 
      if (rightDist > 0){
        this.fire('floating-submenu-clipped', rightDist)
      }
      Platform.flush()

    }
  })
</script>
</polymer-element>